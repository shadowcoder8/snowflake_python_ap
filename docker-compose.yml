services:
  api:
    image: ghcr.io/${GITHUB_REPOSITORY:-your-username/snowflake-api}:latest
    container_name: snowflake_api
    restart: always
    ports:
      - "8000:8000"
    # We keep env_file for local dev with .env, but 'environment' section overrides it if variables are set
    env_file:
      - path: .env
        required: false
    environment:
      # Secrets (Passed from GitHub Actions / Codespaces)
      - SNOWFLAKE_ACCOUNT
      - SNOWFLAKE_USER
      - SNOWFLAKE_ROLE
      - SNOWFLAKE_WAREHOUSE
      - SNOWFLAKE_DATABASE
      - SNOWFLAKE_SCHEMA
      - SNOWFLAKE_PRIVATE_KEY_PASSPHRASE
      - SNOWFLAKE_PRIVATE_KEY_CONTENT
      - API_KEY
      - ADMIN_SECRET
      - APP_ENV=production
      
      # Configuration (Optional, defaults in code)
      - LOG_LEVEL
      - RATE_LIMIT_HEALTH
      - RATE_LIMIT_PRODUCTS
      - RATE_LIMIT_PRODUCT_DETAIL
      - DEFAULT_PAGE_LIMIT
      - MAX_PAGE_LIMIT

      # Paths (Fallback if content not provided)
      - SNOWFLAKE_PRIVATE_KEY_PATH=/app/secrets/rsa_key.p8
    volumes:
      # Mount the local key file (optional now, since we have CONTENT variable)
      - ./rsa_key.p8:/app/secrets/rsa_key.p8:ro

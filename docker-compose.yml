services:
  api:
    image: ghcr.io/${GITHUB_REPOSITORY:-your-username/snowflake-api}:latest
    container_name: snowflake_api
    restart: always
    ports:
      - "8000:8000"
    # We rely on pass-through environment variables.
    # Locally, Docker Compose automatically reads .env to populate these.
    # In Codespaces, GitHub Secrets populate these.
    environment:
      # Secrets (Passed from GitHub Actions / Codespaces)
      - SNOWFLAKE_ACCOUNT
      - SNOWFLAKE_USER
      - SNOWFLAKE_ROLE
      - SNOWFLAKE_WAREHOUSE
      - SNOWFLAKE_DATABASE
      - SNOWFLAKE_SCHEMA
      - SNOWFLAKE_PRIVATE_KEY_PASSPHRASE
      - SNOWFLAKE_PRIVATE_KEY_CONTENT
      - API_KEY
      - ADMIN_SECRET
      - APP_ENV=production
      
      # Configuration (Optional, defaults in code)
      - LOG_LEVEL
      - RATE_LIMIT_HEALTH
      - RATE_LIMIT_PRODUCTS
      - RATE_LIMIT_PRODUCT_DETAIL
      - DEFAULT_PAGE_LIMIT
      - MAX_PAGE_LIMIT

      # Paths (Fallback if content not provided)
      - SNOWFLAKE_PRIVATE_KEY_PATH=/app/secrets/rsa_key.p8
    
    # Overriding command to keep container running for debugging if app fails
    # In production you would remove this
    command: /bin/bash -c "while sleep 1000; do :; done"
